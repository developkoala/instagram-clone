# Instagram Clone - 기능 명세서

## 📱 실시간 채팅 시스템

### 구현 완료된 기능

#### 1. WebSocket 실시간 통신
- **연결 관리**: JWT 토큰 기반 인증
- **자동 재연결**: 연결 끊김 시 자동 재시도 (최대 5회)
- **Ping-Pong**: 30초마다 연결 상태 확인

#### 2. 메시지 기능
- **실시간 전송/수신**: 양방향 실시간 통신
- **메시지 상태**: 읽음/안읽음 처리
- **메시지 미리보기**: 대화 목록에서 마지막 메시지 표시
- **중복 방지**: 동일 메시지 ID 체크

#### 3. 알림 시스템
- **토스트 알림**: 새 메시지 수신 시 우측 하단 알림
  - 발신자 이름과 메시지 미리보기 (최대 50자)
  - 5초 후 자동 사라짐
  - 수동 닫기 가능
- **본인 메시지 제외**: 자신이 보낸 메시지는 알림 없음
- **아이콘 표시**: 메시지 유형별 다른 아이콘
  - 💬 채팅 메시지
  - ✅ 성공 메시지
  - ❌ 에러 메시지
  - ℹ️ 정보 메시지

#### 4. 시간 표시
- **실시간 업데이트**: 
  - 메시지 시간: 30초마다 자동 갱신
  - 대화 목록: 1분마다 자동 갱신
- **상대 시간**: "방금 전", "3분 전", "1시간 전" 형식

#### 5. UI/UX
- **토스트 디자인**:
  - 반투명 배경 (backdrop-blur)
  - 슬라이드 애니메이션
  - 색상별 구분 (성공/에러/정보)
  - Lucide 아이콘 사용
- **위치**: 우측 하단 고정
- **반응형**: 모바일/데스크톱 대응

---

## 🔐 관리자 시스템

### 관리자 계정
- **ID**: admin
- **PW**: pass123
- **접속**: /admin

### 관리 기능
1. **사용자 관리**
   - 사용자 목록 조회 (페이지네이션)
   - 사용자 검색
   - 사용자 삭제

2. **게시물 관리**
   - 게시물 목록 조회
   - 게시물 삭제
   - 이미지 파일 정리

3. **통계 대시보드**
   - 전체 사용자/게시물/좋아요/댓글 수
   - 최근 가입 사용자
   - 최근 게시물
   - 일자별 통계 (7일)

---

## 🎨 UI 컴포넌트

### RelativeTime 컴포넌트
```tsx
<RelativeTime 
  date={message.created_at}
  className="text-xs text-gray-500"
  updateInterval={30000}  // 30초마다 업데이트
/>
```

### Toast 알림
```tsx
showToast(
  message: string,
  type: 'success' | 'error' | 'info',
  duration: number  // 밀리초
)
```

---

## 🔄 데이터 흐름

### 메시지 전송 흐름
1. 사용자가 메시지 입력 후 전송
2. API 호출로 DB에 저장
3. 백엔드에서 WebSocket으로 양쪽 사용자에게 전송
   - 발신자: `is_own: true`
   - 수신자: `is_own: false`
4. 프론트엔드에서 WebSocket 메시지 수신
5. 화면 업데이트 및 토스트 알림 표시

### 읽음 처리 흐름
1. 대화방 열기 (`GET /api/messages/conversations/{id}/messages`)
2. 서버에서 자동으로 상대방 메시지 읽음 처리
3. `unread_count` 초기화

---

## 📊 데이터베이스 스키마

### conversations 테이블
```sql
- id: TEXT PRIMARY KEY
- participant1_id: TEXT (정렬된 작은 ID)
- participant2_id: TEXT (정렬된 큰 ID)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### messages 테이블
```sql
- id: TEXT PRIMARY KEY
- conversation_id: TEXT
- sender_id: TEXT
- content: TEXT
- message_type: TEXT ('text', 'image', 'file')
- is_read: INTEGER (0/1)
- created_at: TIMESTAMP
```

---

## 🚀 성능 최적화

1. **메시지 중복 방지**: ID 기반 체크
2. **불필요한 리렌더링 방지**: 
   - 본인 메시지는 대화 목록 갱신 안함
   - 현재 대화방만 메시지 추가
3. **메모리 관리**: 
   - 컴포넌트 언마운트 시 이벤트 리스너 정리
   - 인터벌 타이머 정리
4. **네트워크 최적화**:
   - WebSocket 재연결 백오프
   - Ping-Pong으로 연결 유지

---

## 🐛 알려진 이슈 및 개선사항

### 개선 필요
1. 메시지 암호화 (End-to-End)
2. 파일/이미지 전송
3. 메시지 검색
4. 메시지 삭제/수정
5. 그룹 채팅
6. 음성/영상 통화

### 버그 수정 완료
- ✅ 새로고침해야 메시지 보이는 문제
- ✅ 실시간 시간 업데이트 안되는 문제
- ✅ 채팅 알림 없는 문제

---

## 📝 테스트 시나리오

### 채팅 테스트
1. coding@gmail.com 로그인
2. coder@gmail.com에게 메시지 전송
3. 다른 브라우저에서 coder@gmail.com 로그인
4. 실시간 메시지 수신 및 알림 확인
5. 메시지 읽음 처리 확인

### 알림 테스트
1. 두 계정으로 각각 로그인 (다른 브라우저)
2. A가 B에게 메시지 전송
3. B 화면에 토스트 알림 표시 확인
4. 5초 후 자동 사라짐 확인
5. X 버튼으로 수동 닫기 테스트