name: ğŸš€ Auto Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    name: ğŸ“¦ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“ Create/Update deploy script on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ëŠ” ê²½ìš°)
            mkdir -p /var/www/muksta
            
            # deploy.sh ìŠ¤í¬ë¦½íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
            cat > /var/www/muksta/deploy.sh << 'EOSCRIPT'
          #!/bin/bash
          
          # ìƒ‰ìƒ ì •ì˜
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m' # No Color
          
          # ë¡œê·¸ í•¨ìˆ˜
          log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
          log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
          log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
          log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
          
          # ë°°í¬ ì‹œì‘
          echo "========================================="
          echo "ğŸš€ Muksta Clone Auto Deployment"
          echo "========================================="
          log_info "ë°°í¬ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # í”„ë¡œì íŠ¸ ê²½ë¡œ
          PROJECT_DIR="/var/www/muksta"
          cd $PROJECT_DIR
          
          # 1. Git Pull
          log_info "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          if git pull origin main; then
              log_success "ì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
              log_error "Git pull ì‹¤íŒ¨"
              exit 1
          fi
          
          # 2. Backend ì˜ì¡´ì„± ì„¤ì¹˜
          log_info "ğŸ“¦ Backend íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
          cd $PROJECT_DIR/backend
          
          # ê°€ìƒí™˜ê²½ í™œì„±í™” (ìˆëŠ” ê²½ìš°)
          if [ -f "venv/bin/activate" ]; then
              source venv/bin/activate
          fi
          
          # requirements.txt ì„¤ì¹˜
          if pip install -r requirements.txt --quiet; then
              log_success "Backend íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
          else
              log_warning "ì¼ë¶€ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          fi
          
          # 3. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
          log_info "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘..."
          if alembic upgrade head; then
              log_success "ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"
          else
              log_warning "ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨ ë˜ëŠ” ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
          
          # 4. Frontend ë¹Œë“œ (í•„ìš”í•œ ê²½ìš°)
          if [ -d "$PROJECT_DIR/frontend" ]; then
              log_info "ğŸ—ï¸ Frontend ë¹Œë“œ ì¤‘..."
              cd $PROJECT_DIR/frontend
              
              # node_modules ì„¤ì¹˜
              if [ ! -d "node_modules" ] || [ "package.json" -nt "node_modules" ]; then
                  log_info "Node íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
                  npm ci --silent
              fi
              
              # í”„ë¡œë•ì…˜ ë¹Œë“œ
              if npm run build --silent; then
                  log_success "Frontend ë¹Œë“œ ì™„ë£Œ"
              else
                  log_warning "Frontend ë¹Œë“œ ì‹¤íŒ¨ (ê¸°ì¡´ ë¹Œë“œ ì‚¬ìš©)"
              fi
          fi
          
          # 5. PM2 í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘
          log_info "â™»ï¸ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
          cd $PROJECT_DIR
          
          # PM2 í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì¬ì‹œì‘
          if pm2 list | grep -q "muksta"; then
              pm2 restart all --update-env
              log_success "PM2 í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ"
          else
              # PM2 í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìœ¼ë©´ ì‹œì‘
              log_info "PM2 í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì¤‘..."
              
              # Backend ì‹œì‘
              cd $PROJECT_DIR/backend
              pm2 start "uvicorn app.main:app --host 0.0.0.0 --port 8000" --name muksta-backend
              
              # Frontend ì‹œì‘ (ê°œë°œì„œë²„ ëŒ€ì‹  nginx ì‚¬ìš© ê¶Œì¥)
              cd $PROJECT_DIR/frontend
              pm2 start "npm run preview -- --port 3000" --name muksta-frontend
              
              pm2 save
              log_success "PM2 í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì™„ë£Œ"
          fi
          
          # 6. ìƒíƒœ í™•ì¸
          log_info "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
          pm2 list
          
          # 7. í—¬ìŠ¤ì²´í¬
          sleep 3
          log_info "ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              log_success "Backend ì„œë¹„ìŠ¤ ì •ìƒ ì‘ë™ ì¤‘"
          else
              log_error "Backend ì„œë¹„ìŠ¤ ì‘ë‹µ ì—†ìŒ"
          fi
          
          # ë°°í¬ ì™„ë£Œ
          echo "========================================="
          log_success "ğŸ‰ ë°°í¬ ì™„ë£Œ: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "========================================="
          EOSCRIPT
            
            # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x /var/www/muksta/deploy.sh
            echo "âœ… Deploy script created/updated successfully"
          ENDSSH

      - name: ğŸš€ Execute deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd /var/www/muksta
            ./deploy.sh
          ENDSSH

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: ğŸ“¢ Deployment Status
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Server: ${{ secrets.SERVER_HOST }}"
          echo "ğŸ“… Time: $(date '+%Y-%m-%d %H:%M:%S')"

      - name: ğŸ“¢ Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs for more information."